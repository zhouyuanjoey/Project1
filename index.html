<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 35px;
        padding: 0px;
      }
      #myCanvas {
        border: 5px solid #000000;
      }
    </style>
    <script>
	var Dynamic=1;
        var player=-1;
var step=0.1;
	window.onload = function() {
        var reqFrame = function(callback){
	    window.setTimeout(callback,5);
	}
	var canvas = document.getElementById("myCanvas");
        var context = canvas.getContext("2d");
	var StrokeColor = 'red';
	var StrokeWidth = 10;
	var FaceColor = 'yellow';
	var ChooseColor = 'green';
	var circ = Math.PI*2;
	var FaceRadius = 70;
	var EyeRadius  = 14; 
	var MouthRadius = 30; 
	var HorizontalSpeed = 5;
	var VerticalEnergy = canvas.height-FaceRadius;
	var aFace = {
	    "x" : canvas.width / 2,
	    "y" : canvas.height / 2,
	    "vX" : HorizontalSpeed,
	    "vY" : Math.sqrt(VerticalEnergy- (canvas.height-"y")),
	    "color" : FaceColor,
	    "VerticalEnergy": VerticalEnergy,
	    draw : function(){
		 context.strokeStyle = StrokeColor;
		 context.lineWidth = StrokeWidth;
		 context.fillStyle = this.color;
		 context.beginPath();
		 context.arc(this.x,this.y,FaceRadius,0,circ,true);
		 context.stroke();
		 context.fill();
		 context.fillStyle = StrokeColor;
		 context.beginPath();
		 context.arc(this.x-FaceRadius*0.4,this.y-FaceRadius*0.3,EyeRadius,0,circ,true);
		 context.arc(this.x+FaceRadius*0.4,this.y-FaceRadius*0.3,EyeRadius,0,circ,true);
		 context.fill();
		 context.beginPath();
		 context.lineCap = 'round';
		 context.arc(this.x,this.y+FaceRadius*0.1,MouthRadius,Math.PI*0.5-0.8,Math.PI*0.5+0.8,false);
		 context.stroke();
	    },	    
	    move: function(){		    
   		if (canvas.height-this.y>this.VerticalEnergy-1){
		    this.y = canvas.height-this.VerticalEnergy+1;
		    this.vY = 1;
		}
		else{
		    this.vY = Math.sqrt(this.VerticalEnergy- (canvas.height-this.y))*(this.vY > 0 ? 1 : -1);
		}
		this.x += step*this.vX;
		this.y += step*this.vY;
		if (this.x > canvas.width-FaceRadius){
		    if (this.vX > 0){
			this.vX = -this.vX;
		    }
		}
		if (this.y > canvas.height-FaceRadius){
		    if (this.vY > 0){
			this.vY = -this.vY;
		    }
		}
		if (this.x < FaceRadius){
		    if (this.vX < 0){
			this.vX = -this.vX;
		    }
		}
		if (this.y < FaceRadius){
		    if (this.vY < 0){
			this.vY = -this.vY;
		    }
		}
	    }
	}

	function makeFace(x,y){
	    Empty = function(){};
	    Empty.prototype = aFace;
	    Face = new Empty();
	    Face.x = x;
	    Face.y = y > FaceRadius ? y : FaceRadius;
	    Face.vY = Math.sqrt(Face.y-FaceRadius);
	    return Face;
	}

	theFaces= [];
	theFaces.push(makeFace(canvas.width/2,canvas.height/2));

	function doClick(evt){
	    if (!evt.ctrlKey){
		var newx=evt.pageX - canvas.offsetLeft;
		var newy=evt.pageY - canvas.offsetTop;
		var symbol=0;
		for (var i=0;i<theFaces.length;i++){
		    if ((newx-theFaces[i].x)*(newx-theFaces[i].x)+(newy-theFaces[i].y)*(newy-theFaces[i].y)<4*FaceRadius*FaceRadius){
			symbol=1;
			break;
		    }
		}
		if (symbol==0){
		    theFaces.push(makeFace(evt.pageX - canvas.offsetLeft, evt.pageY - canvas.offsetTop));
		}
	    }
	    else{
		player=-1;
		for (var i=0;i<theFaces.length;i++){
		    var dx=evt.pageX - canvas.offsetLeft-theFaces[i].x;
		    var dy=evt.pageY - canvas.offsetTop-theFaces[i].y;
		    if (dx*dx+dy*dy<FaceRadius*FaceRadius){
			theFaces[i].color=ChooseColor;
			theFaces[i].vX=0;
			theFaces[i].vY=0;
			theFaces[i].VerticalEnergy=canvas.height-theFaces[i].y;
			player=i;
		    }
		    else{
			theFaces[i].color=FaceColor;
		    }
		}	
	    }
	}
	function doKeyPress(evt){
	    if (evt.keyCode==13){
		Dynamic=1-Dynamic;
	    }
	    else{
		switch(evt.keyCode){
		case 38:
		theFaces[player].y-=20;
		if (theFaces[player].y<FaceRadius){
		    theFaces[player].y=FaceRadius;
		}
		theFaces[player].VerticalEnergy=canvas.height-theFaces[player].y;
		break;
		case 40:
		theFaces[player].y+=20;
		if (theFaces[player].y>canvas.height-FaceRadius){
		    theFaces[player].y=canvas.height-FaceRadius;
		}
		theFaces[player].VerticalEnergy=canvas.height-theFaces[player].y;
		break;
		case 37:
		theFaces[player].x-=20;
		if (theFaces[player].x<FaceRadius){
		    theFaces[player].x=FaceRadius;
		}
		theFaces[player].VerticalEnergy=canvas.height-theFaces[player].y;
		break;
		case 39:
		theFaces[player].x+=20;
		if (theFaces[player].x>canvas.width-FaceRadius){
		    theFaces[player].x=canvas.width-FaceRadius;
		}
		theFaces[player].VerticalEnergy=canvas.height-theFaces[player].y;
		break;
		}
		
	    }
	}
	canvas.addEventListener("click",doClick,false);
	window.addEventListener("keydown",doKeyPress,false);
	

	function drawFaces(){
	    context.clearRect(0, 0, canvas.width, canvas.height); 
	    for (var i=0;i<theFaces.length;i++){
		theFaces[i].draw();
	    }
	}

	function bounce(theFaces) {   		
	    for(var i=theFaces.length-1; i>=1; i--) {
		var bi = theFaces[i];
		var bix = bi.x;
		var biy = bi.y;
		for(var j=i-1; j>=0; j--) {
		    var bj = theFaces[j];
		    var bjx = bj.x;
		    var bjy = bj.y;
		    var dx = bjx - bix;
		    var dy = bjy - biy;
		    var d = dx*dx+dy*dy;
		    if (d < 4*FaceRadius*FaceRadius) {		    
			if (i==player){
			    if (-bj.vX*dx-bj.vY*dy<0){
			    }
			    else{
				bj.vX=-bj.vX;
				bj.vY=-bj.vY;
			    }
			    continue;
			}
			else{
			    if (j==player){
				if (bi.vX*dx+bi.vY*dy<0){
				}
				else{
				    bi.vX=-bi.vX;
				    bi.vY=-bi.vY;
				}
				continue;
			    }
			    else{
				if (bi.vX*dx+bi.vY*dy-bj.vX*dx-bj.vY*dy<0){
				}
				else{				    
				    var ixgive=dx*(bi.vX*dx+bi.vY*dy)/(dx*dx+dy*dy);
				    var iygive=dy*(bi.vX*dx+bi.vY*dy)/(dx*dx+dy*dy);
				    var jxgive=dx*(bj.vX*dx+bj.vY*dy)/(dx*dx+dy*dy);
				    var jygive=dy*(bj.vX*dx+bj.vY*dy)/(dx*dx+dy*dy);
				    bj.VerticalEnergy+=(bj.vY+iygive-jygive)*(bj.vY+iygive-jygive)-bj.vY*bj.vY;
				    bi.VerticalEnergy+=(bi.vY+jygive-iygive)*(bi.vY+jygive-iygive)-bi.vY*bi.vY;			
				    bj.vX += ixgive-jxgive;
				    bj.vY += iygive-jygive;
				    bi.vX += jxgive-ixgive;
				    bi.vY += jygive-iygive;
				}
			    }
			}
		    }
		}
	    }
	}

	function moveFaces(){
	    bounce(theFaces);
	    for (var i=0;i<theFaces.length;i++){
		if (i!=player){
		    theFaces[i].move();
		}
	    }
	}
	    

	function drawLoop(){
	    if (Dynamic==1){
		moveFaces();
	    }
	
	    drawFaces();
	    reqFrame(drawLoop);
	}	
	
	drawLoop();
      };

    </script>
  </head>
  <body>
	<canvas id="myCanvas" width="1600" height="700"></canvas>
  </body>
</html>
