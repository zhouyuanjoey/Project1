<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
      margin: 50px;
      padding: 0px;
      }
      #myCanvas {
      border: 5px solid #000000;
      }
    </style>
    <script>
      	
      window.onload = function() {
	  var reqFrame =window.requestAnimationFrame ||
	          window.webkitRequestAnimationFrame ||
	          window.mozRequestAnimationFrame ||
	          window.oRequestAnimationFrame ||
	          window.msRequestAnimationFrame ||
	          function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element){
	      window.setTimeout(callback, 20);
	  };

	  var canvas = document.getElementById('myCanvas');
	  var context = canvas.getContext('2d');
	  var sight=200;

	  var object = {
	      "img" : null,
	      "rot" : 0,
	      "x" : 0,
	      "y" : 0,
	      "width" : 0,
	      "height" : 0,
	      "targetx": 0,
	      "targety": 0,
	      "speed": 0,
	      "maxlife": 0,
	      "life": 0,
	      "destroy" : 0,
	      "belong" : 0,
	      draw : function() {
		   simrotateImage(this.rot, this.img, this.x, this.y, this.width, this.height);
		   if (this.maxlife!=0){
		       context.fillStyle='red';
		       context.beginPath();
		       context.rect(this.x-0.3*this.width,this.y-0.7*this.height,0.6*this.life/this.maxlife*this.width,0.1*this.height);
		       context.fill();
		       context.fillStyle='black';
		       context.beginPath();
		       context.rect(this.x-0.3*this.width+0.6*this.life/this.maxlife*this.width,this.y-0.7*this.height,0.6*(1-this.life/this.maxlife)*this.width,0.1*this.height);
		       context.fill();		       
		       context.lineWidth=2;
		       context.strokeStyle='white';
		       context.beginPath();
		       context.rect(this.x-0.3*this.width,this.y-0.7*this.height,0.6*this.width,0.1*this.height);
		       context.stroke();
		   }
	      }		  
	  };

	  function comrotateImage(rot, img, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight) {//drawing a rotated image on the canvas, complicated version
	      context.translate(destX,destY);
	      context.rotate(-rot);
	      context.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, -destWidth/2, -destHeight/2, destWidth, destHeight);
	      context.rotate(rot);
	      context.translate(-destX,-destY);
	  }
	  
	  function simrotateImage(rot, img, destX, destY, destWidth, destHeight) {//drawing a rototed image on the canvas, simple version
	      context.translate(destX,destY);
	      context.rotate(-rot);
	      context.drawImage(img, -destWidth/2, -destHeight/2, destWidth, destHeight);
	      context.rotate(rot);
	      context.translate(-destX,-destY);
	  }




	  function makeObject(img,rot,x,y,width,height,targetx,targety,speed,maxlife,life,destroy,belong) {
	      Empty = function () {};
	      Empty.prototype = object;	// don't ask why not ball.prototype=aBall;
	      obj = new Empty();
	      obj.img = img;
	      obj.rot = rot;
	      obj.x = x;
	      obj.y = y;
	      obj.width = width;
	      obj.height = height;
	      obj.targetx = targetx;
	      obj.targety = targety;
	      obj.speed = speed;
	      obj.maxlife = maxlife;
	      obj.life = life;
	      obj.destroy = destroy;
	      obj.belong = belong;
	      return obj;
	  }
	  
	  var objectSet=[];
	  var moveSet=[];
	  var bulletSet=[];
	  var otherSet=[];
	  var mapload=0;
	  var castleload=0;
	  var planeload=0;
	  var bulletload=0;

	  var map = new Image();
	  map.src = 'map.png';
	  map.onload=function(){
	      mapload=1;
	  }
	  var UpperLeftX=0;
	  var UpperLeftY=map.height/4;
	  var sourceWidth=map.width/2;
	  var sourceHeight=map.height/2;	      

	  var castle = new Image();
	  var destWidth = 100;
	  var destHeight = 100;
	  var destX = (900-UpperLeftX)/sourceWidth*canvas.width;
	  var destY = (452-UpperLeftY)/sourceHeight*canvas.height;
	  objectSet.push(makeObject(castle,0,destX,destY,destWidth,destHeight,destX,destY,0,2000,2000,0,0));
	  otherSet.push(0);
	  castle.src = 'castle.png';
	  castle.onload = function(){
	      castleload=1;
	  }
	  
	  var plane = new Image();	
	  destWidth = 111;
	  destHeight = 70;
	  destX = 50;
	  destY = canvas.height/2;
	  objectSet.push(makeObject(plane,0,destX,destY,destWidth,destHeight,destX,destY,10,100,100,0,1));
	  moveSet.push(1);	  
	  plane.src = 'plane.png';
	  plane.onload = function(){
	      planeload=1;
	  }

	  var bullet = new Image();
	  bullet.src = 'bullet.png';
	  bullet.onload = function(){
	      bulletload=1;
	  }

	  function doClick(evt){
	      for (var i=0;i<moveSet.length;i++){
		  objectSet[moveSet[i]].targetx = evt.pageX - canvas.offsetLeft;
		  objectSet[moveSet[i]].targety = evt.pageY - canvas.offsetTop;
	      }
	  }

	  function draws() {
	      for (var i=0;i<objectSet.length;i++){
	       	  objectSet[i].draw();
	      }
	  }

	  function moves() {
	      var preX=UpperLeftX;
	      var preY=UpperLeftY;
	      for (var i=0;i<moveSet.length;i++){
		  var dx=objectSet[moveSet[i]].targetx-objectSet[moveSet[i]].x;
		  var dy=objectSet[moveSet[i]].targety-objectSet[moveSet[i]].y;
		  if (dy==0 && dx==0){
		  }
		  else{
		      objectSet[moveSet[i]].rot=-Math.atan2(dy,dx);
		  }
		  if (dx*dx+dy*dy>objectSet[moveSet[i]].speed*objectSet[moveSet[i]].speed){
		      objectSet[moveSet[i]].x+=objectSet[moveSet[i]].speed*dx/Math.sqrt(dx*dx+dy*dy);
		      objectSet[moveSet[i]].y+=objectSet[moveSet[i]].speed*dy/Math.sqrt(dx*dx+dy*dy);
		  }
		  else{
		      objectSet[moveSet[i]].x=objectSet[moveSet[i]].targetx;
		      objectSet[moveSet[i]].y=objectSet[moveSet[i]].targety;
		  }
		  if (objectSet[moveSet[i]].x<sight){
		      UpperLeftX-=(sight-objectSet[moveSet[i]].x)/canvas.width*sourceWidth;
		  }
   
		  if (UpperLeftX<0){
		      UpperLeftX=0;
		  }
		  if (objectSet[moveSet[i]].x>canvas.width-1-sight){
		      UpperLeftX+=(objectSet[moveSet[i]].x-(canvas.width-1-sight))/canvas.width*sourceWidth;
		  }
		  if (UpperLeftX+sourceWidth>map.width-1){
		      UpperLeftX=map.width-1-sourceWidth;
		  }

		   if (objectSet[moveSet[i]].y<sight){
		      UpperLeftY-=(sight-objectSet[moveSet[i]].y)/canvas.height*sourceHeight;
		  }
		  
		  if (UpperLeftY<0){
		      UpperLeftY=0;
		  }

		  if (objectSet[moveSet[i]].y>canvas.height-1-sight){
		      UpperLeftY+=(objectSet[moveSet[i]].y-(canvas.height-1-sight))/canvas.height*sourceHeight;
		  } 


		  if (UpperLeftY+sourceHeight>map.height-1){
		      UpperLeftY=map.height-1-sourceHeight;
		  }		    
	      }

	      for (var i=0;i<bulletSet.length;i++){
		  objectSet[bulletSet[i]].x+=objectSet[bulletSet[i]].speed*Math.cos(objectSet[bulletSet[i]].rot);
		  objectSet[bulletSet[i]].y-=objectSet[bulletSet[i]].speed*Math.sin(objectSet[bulletSet[i]].rot);
	      }		  
	      
	      for (var i=0;i<objectSet.length;i++){
		  objectSet[i].x-=(UpperLeftX-preX)/sourceWidth*canvas.width;
		  objectSet[i].y-=(UpperLeftY-preY)/sourceHeight*canvas.height;
	      }
	      for (var i=0;i<moveSet.length;i++){
		  objectSet[moveSet[i]].targetx-=(UpperLeftX-preX)/sourceWidth*canvas.width;
		  objectSet[moveSet[i]].targety-=(UpperLeftY-preY)/sourceHeight*canvas.height;
	      }	      
	  }

	  function hitTest(){
	      for (var i=0;i<bulletSet.length;i++){
		  if (objectSet[bulletSet[i]].x>(map.width-1-UpperLeftX)/sourceWidth*canvas.width || objectSet[bulletSet[i]].x<(0-UpperLeftX)/sourceWidth*canvas.width || objectSet[bulletSet[i]].y>(map.height-1-UpperLeftY)/sourceHeight*canvas.height || objectSet[bulletSet[i]].y<(0-UpperLeftY)/sourceHeight*canvas.height){
		      objectSet[bulletSet[i]].destroy=1;
		  }
		  else{
		      var collide=0;
		      for (var j=0;j<moveSet.length;j++){
		       	  if (objectSet[bulletSet[i]].belong==moveSet[j]){
		       	      continue;
		       	  }
		      	  if (objectSet[bulletSet[i]].x>=objectSet[moveSet[j]].x-objectSet[moveSet[j]].width/2 && objectSet[bulletSet[i]].x<=objectSet[moveSet[j]].x+objectSet[moveSet[j]].width/2 && objectSet[bulletSet[i]].y>=objectSet[moveSet[j]].y-objectSet[moveSet[j]].height/2 && objectSet[bulletSet[i]].y<=objectSet[moveSet[j]].y+objectSet[moveSet[j]].height/2){
		      	      objectSet[bulletSet[i]].destroy=1;
			      objectSet[moveSet[j]].life-=100;
			      if (objectSet[moveSet[j]].life<=0){
				  objectSet[moveSet[j]].destroy=1;
			      }
		      	      collide=1;
		      	      break;
		      	  }
		      }
		      if (collide==1){
		      	  continue;
		      }
		      for (var j=0;j<otherSet.length;j++){
		      	  if (objectSet[bulletSet[i]].belong==otherSet[j]){
		      	      continue;
		      	  }
		      	  if (objectSet[bulletSet[i]].x>=objectSet[otherSet[j]].x-objectSet[otherSet[j]].width/2 && objectSet[bulletSet[i]].x<=objectSet[otherSet[j]].x+objectSet[otherSet[j]].width/2 && objectSet[bulletSet[i]].y>=objectSet[otherSet[j]].y-objectSet[otherSet[j]].height/2 && objectSet[bulletSet[i]].y<=objectSet[otherSet[j]].y+objectSet[otherSet[j]].height/2){
		      	      objectSet[bulletSet[i]].destroy=1;
			      objectSet[otherSet[j]].life-=100;
			      if (objectSet[otherSet[j]].life<=0){
				  objectSet[otherSet[j]].destroy=1;
			      }
		      	      collide=1;
		      	      break;
		      	  }
		      }
		  }	      
	      }
	  }   
	      

	  function destroy(){		  
	      var i=0;
	      while(i<bulletSet.length){
		  if (objectSet[bulletSet[i]].destroy==1){
		      objectSet.splice(bulletSet[i],1);
		      for (var j=0;j<bulletSet.length;j++){
		  	  if (bulletSet[j]>bulletSet[i]){
		  	      bulletSet[j]--;
		  	  }
		      }
		      for (var j=0;j<moveSet.length;j++){
		  	  if (moveSet[j]>bulletSet[i]){
		  	      moveSet[j]--;
		  	  }
		      }
		      for (var j=0;j<otherSet.length;j++){
		  	  if (otherSet[j]>bulletSet[i]){
		  	      otherSet[j]--;
		  	  }
		      }
		      bulletSet.splice(i,1);
		  }
		  else{
		      i++;
		  }	
		  i++;
	      }
	      i=0;
	      while(i<moveSet.length){
		  if (objectSet[moveSet[i]].destroy==1){
		      objectSet.splice(moveSet[i],1);
		       for (var j=0;j<bulletSet.length;j++){
		  	  if (bulletSet[j]>moveSet[i]){
		  	      bulletSet[j]--;
		  	  }
		      }
		      for (var j=0;j<moveSet.length;j++){
		  	  if (moveSet[j]>moveSet[i]){
		  	      moveSet[j]--;
		  	  }
		      }
		      for (var j=0;j<otherSet.length;j++){
		  	  if (otherSet[j]>moveSet[i]){
		  	      otherSet[j]--;
		  	  }
		      }
		    
		      moveSet.splice(i,1);
		  }
		  else{
		      i++;
		  }	
		  i++;
	      }
	      i=0;
	      while(i<otherSet.length){
		  if (objectSet[otherSet[i]].destroy==1){
		      objectSet.splice(otherSet[i],1);
		      for (var j=0;j<bulletSet.length;j++){
		  	  if (bulletSet[j]>otherSet[i]){
		  	      bulletSet[j]--;
		  	  }
		      }
		      for (var j=0;j<moveSet.length;j++){
		  	  if (moveSet[j]>otherSet[i]){
		  	      moveSet[j]--;
		  	  }
		      }
		      for (var j=0;j<otherSet.length;j++){
		  	  if (otherSet[j]>otherSet[i]){
		  	      otherSet[j]--;
		  	  }
		      }
		     
		      otherSet.splice(i,1);
		  }
		  else{
		      i++;
		  }	
		  i++;
	      }	      
	  }

	  function drawBackGround() {
     	      var destWidth = canvas.width;
	      var destHeight = canvas.height;
	      var destX = canvas.width/2;
	      var destY = canvas.height/2;
	      comrotateImage(0, map, UpperLeftX, UpperLeftY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
	     
	  }

	  function drawLoop() {
	      if (mapload==1 && planeload==1 && castleload==1 && bulletload==1){
		  drawBackGround();
		  moves();
		  hitTest();
		  destroy();
		  draws();
		  if (otherSet.length==0){
		      context.font = '60pt Calibri';
		      context.textAlign= 'center';
		      context.textBasline= 'middle';
		      context.fillStyle = 'red';
		      context.fillText('You Win!', canvas.width/2, canvas.height/2);		  
		      return;
		  }
	      }
	      reqFrame(drawLoop);	
	  }

	  function doShoot(evt) {
	      if (evt.keyCode==49){
		  for (var i=0;i<moveSet.length;i++){
		      bulletSet.push(objectSet.length);
		      objectSet.push(makeObject(bullet,objectSet[moveSet[i]].rot,objectSet[moveSet[i]].x,objectSet[moveSet[i]].y,15,5,0,0,20,0,0,0,moveSet[i]));
		  }
	      }
	  }

	  canvas.addEventListener("click",doClick,false);
	  window.addEventListener("keydown",doShoot,false);
	  drawLoop();
      }

</script>
  </head>
  <body>
    <canvas id="myCanvas" width="1250" height="550"></canvas>
  </body>
</html>
